import{bQ as Y,d as w,x as h,w as C,h as e,v as D,i as R,l as J,dX as G,m as K,ci as X,b$ as L,u as Q,dq as O,z as b,bj as Z,R as g,bY as _,k as N,dY as S,aF as W,s as ee,bT as te,bU as M,N as F,aX as ae,dZ as ne,F as k,p as ue,cP as re,a as P,I as V,d_ as se,g as oe,A as le,n as ie}from"./index-a65640c4.js";import{H as E}from"./rounded-button-0a332d37.js";import{u as z}from"./use-react-0878e019.js";import{d as ce,l as $}from"./js-yaml-fae8e8ce.js";import{u as pe,T as de,p as j}from"./use-async-monaco-8e4be581.js";import{F as me,S as ve,d as fe,a as ye,b as y}from"./index-e5feec32.js";import{o as he}from"./omit-cd9fa3f3.js";import{_ as ge}from"./CheckCircleOutlined-e80d11fd.js";import{N as T}from"./Form-8fe34e05.js";import{N as f}from"./FormItem-e5a28df6.js";import{N as Fe}from"./Select-1fa08aad.js";import{N as we}from"./Switch-36a3e36a.js";import{D as be}from"./delete-confirm-b94a3663.js";import{T as Ce}from"./index-d8deaa0d.js";import{R as xe}from"./relative-time-76b5cd59.js";import{u as Be}from"./use-table-277d573d.js";import{C as H}from"./index-589e0a43.js";import{E as Ne}from"./ExternalLink-2a9998ba.js";import{N as q}from"./Tag-9eca160d.js";import{N as Se}from"./Popconfirm-2df5e7c0.js";import{N as _e,a as U}from"./Tabs-680d8f27.js";import"./editor.main-759b9211.js";import"./use-save-confirm-31261a7f.js";import"./_arrayEach-2ff48152.js";import"./index-5e6b6cfe.js";import"./DataTable-55862cb2.js";import"./Icon-16beb9bb.js";import"./Forward-f1d961c0.js";import"./ChevronRight-d9341cbf.js";import"./Tooltip-2e2a1070.js";import"./Add-594e9d88.js";import"./throttle-f7c0b27f.js";var I={};Object.defineProperty(I,"__esModule",{value:!0});const B=Y,ke={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 1024 1024"},De=(0,B.createElementVNode)("path",{d:"M832 464h-68V240c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zM540 701v53c0 4.4-3.6 8-8 8h-40c-4.4 0-8-3.6-8-8v-53a48.01 48.01 0 1 1 56 0zm152-237H332V240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v224z",fill:"currentColor"},null,-1),Ee=[De];var Te=I.default=(0,B.defineComponent)({name:"LockFilled",render:function(u,s){return(0,B.openBlock)(),(0,B.createElementBlock)("svg",ke,Ee)}});const Ae=w({props:{onSave:{type:Function},value:{type:String,required:!0},onChange:{type:Function,required:!0},language:{type:String,required:!0}},setup(r){const u=pe(r),s=h();return C(()=>u.value,()=>{!s.value||s.value.loaded&&r.onChange(u.value)}),()=>e("div",{class:"h-full w-full relative"},e(me,{ref:s,value:u,onSave:r.onSave,language:r.language}))}}),Oe=w({setup(){const r=D(),u=R(),s=J(()=>u.query.id),a=G(s.value?"snippet-"+s.value:"snippet",new ve),o=K(s.value?{json:"",yaml:"",text:"",function:""}:{json:JSON.stringify({name:"hello world"},null,2),text:"",yaml:"name: hello world",function:fe});C(()=>a.value.type,n=>{a.value.raw=o[n]}),C(()=>[o.json,o.yaml],X(([n,t],[c,i])=>{const m=n!==c,v=t!==i,A=Z(o);try{m?A.yaml=ce(JSON.parse(n)):v&&(A.json=JSON.stringify($(t),null,2))}catch{}},100)),C(()=>[a.value.type,a.value.schema],([n,t])=>{if(n===y.JSON){if(!a.value.schema){_(()=>import("./editor.main-759b9211.js").then(function(i){return i.e}),["js/editor.main-759b9211.js","assets/editor.main.2109f3ac.css"]).then(i=>{i.languages.json.jsonDefaults.setDiagnosticsOptions({validate:!1})});return}const c=a.value.schema;fetch(c).then(i=>i.text()).then(i=>{_(()=>import("./editor.main-759b9211.js").then(function(m){return m.e}),["js/editor.main-759b9211.js","assets/editor.main.2109f3ac.css"]).then(m=>{m.languages.json.jsonDefaults.setDiagnosticsOptions({validate:!0,schemas:[{uri:c,fileMatch:["*"],schema:JSON.parse(i)}]})})})}}),C(()=>s,async n=>{if(n.value){const t=await g.api.snippets(n.value).get();switch(t.type){case y.JSON:{t.raw=JSON.stringify(JSON.parse(t.raw),null,2);break}}a.value=t,o[t.type]=t.raw}},{immediate:!0});const d=L(),l=Q(),p=async(n=!0)=>{const t=v=>{try{return JSON.stringify(JSON.parse(v),null,0)}catch{l.error("JSON \u683C\u5F0F\u9519\u8BEF")}},c=()=>{const v=o[a.value.type];switch(a.value.type){case y.JSON:return t(v);case y.YAML:{try{$(v)}catch{l.error("YAML \u683C\u5F0F\u9519\u8BEF")}return v}case y.Function:return v;default:return v}},m={...he(a.value,["_id","id","created","data"]),raw:c()};m.metatype||delete m.metatype,s.value?await g.api.snippets(s.value).put({data:m}):await g.api.snippets.post({data:m}),l.success(`${s.value?"\u66F4\u65B0":"\u521B\u5EFA"}\u6210\u529F`),n&&r.replace({query:{...u.query,tab:0}})};return z(()=>(d.setHeaderButtons(e(E,{variant:"success",onClick:()=>p(),icon:e(ge,null)})),()=>{d.setHeaderButtons(null)})),()=>e(de,null,e(O,{span:12},e(T,null,e(f,{label:"\u540D\u79F0",required:!0},e(b,{onUpdateValue:n=>void(a.value.name=n),value:a.value.name})),e(f,{label:"\u5F15\u7528",required:!0},e(b,{value:a.value.reference,onUpdateValue:n=>void(a.value.reference=n),defaultValue:"root"})),e(f,{label:"\u5143\u7C7B\u578B"},e(b,{value:a.value.metatype,onUpdateValue:n=>void(a.value.metatype=n)})),e(f,{label:"\u6570\u636E\u7C7B\u578B"},e(Fe,{value:a.value.type,defaultValue:y.JSON,onUpdateValue:n=>void(a.value.type=n),options:Object.entries(y).map(([n,t])=>({label:n,value:t}))})),e(f,{label:"Schema"},e(b,{value:a.value.schema,onUpdateValue:n=>void(a.value.schema=n)})),e(f,{label:"\u516C\u5F00",labelPlacement:"left"},e("div",{class:"w-full flex justify-end"},e(we,{value:!a.value.private,onUpdateValue:n=>void(a.value.private=!n)}))),e(f,{label:"\u5907\u6CE8"},e(b,{resizable:!1,value:a.value.comment,onUpdateValue:n=>void(a.value.comment=n),type:"textarea",rows:4})))),e(O,{span:24},e(Ae,{onSave:async()=>{await p(!1),l.success("Saved!")},language:ye[a.value.type],value:o[a.value.type],onChange:n=>{o[a.value.type]=n}})))}}),Pe=w({props:{language:{type:String,required:!0},code:{type:String,required:!0}},setup(r){const u=h();return N(()=>{_(()=>import("./editor.main-759b9211.js").then(function(s){return s.e}),["js/editor.main-759b9211.js","assets/editor.main.2109f3ac.css"]).then(s=>{s.editor.colorize(r.code,r.language,{tabSize:2}).then(a=>{u.value.innerHTML=a})})}),()=>e("pre",{ref:u},r.code)}});var x;(r=>{async function u(){return(await S.rest.repos.get({owner:"mx-space",repo:"snippets"})).data}r.fetchRepo=u;async function s(o=""){return(await S.rest.repos.getContent({owner:"mx-space",repo:"snippets",path:o})).data}r.fetchFileTree=s;async function a(o=""){return(await S.rest.search.code({q:`repo:mx-space/snippets in:path ${o}`,sort:"indexed",order:"desc"})).data}r.searchFile=a})(x||(x={}));const Ve=()=>{const r=h([]),u=h(!0);return[r,async()=>{const a=await x.fetchFileTree();Array.isArray(a)&&(r.value=a.filter(({type:o})=>o==="dir").map(({name:o,html_url:d})=>({name:o,url:d||""}))),u.value=!1},u]},$e=w({props:{onFinish:{type:Function,required:!0}},setup(r){const u=h(!1),s=t=>{t.stopPropagation(),t.preventDefault(),n()},[a,o,d]=Ve();W(()=>{u.value&&o()});const l=h(""),p=ee(),n=async()=>{const t=p.create({title:"\u83B7\u53D6\u548C\u89E3\u6790",content:()=>e(je,{name:l.value,onFinish:()=>{t.destroy(),r.onFinish()}}),closable:!0})};return()=>e(k,null,e(E,{variant:"info",onClick:()=>{u.value=!0},icon:e(ne,null)}),e(te,{show:u.value,onUpdateShow:t=>{u.value=t}},e(M,{class:"modal-card sm",title:"\u5BFC\u5165 Snippets"},e(T,{onSubmit:s},e(f,{label:"\u5305\u540D"},e(b,{placeholder:"\u652F\u6301\u5BFC\u5165 GitHub repo:mx-space/snippets \u4E0B\u7684\u96C6\u5408\u5305\uFF0C\u793A\u4F8B\u8F93\u5165: kami",value:l.value,onUpdateValue:t=>{l.value=t}})),e(f,{label:"\u53EF\u83B7\u53D6\u7684"},d.value?e(H,null):e("div",{class:"flex flex-wrap space-x-2"},a.value.map(({name:t,url:c})=>e("div",{class:"flex items-center ml-4",key:"name"},e(F,{text:!0,onClick:()=>{l.value=t,ae(()=>{n()})}},t),e("a",{href:c,target:"_blank",rel:"noopener noreferrer"},e(Ne,{class:"!h-4 !w-4 ml-2"})))))),e("div",{class:"flex justify-end"},e(F,{round:!0,type:"primary",onClick:n},"\u5904\u7406"))))))}}),je=w({props:{name:{type:String,required:!0},onFinish:{type:Function,required:!0}},setup(r){const u=h(!0),s=h([]),a=h([]);N(async()=>{const d=await x.fetchFileTree(r.name);if(Array.isArray(d)){const l=d.map(async p=>{if(p.type==="dir")switch(p.name){case"functions":{const n=await x.fetchFileTree(`${r.name}/functions`);Array.isArray(n)&&await Promise.all(n.map(async t=>{if(t.type==="file"&&/\.(js|ts)$/.test(t.name)){const c=t.download_url;if(!c){message.error("\u83B7\u53D6\u4E0B\u8F7D\u5730\u5740\u5931\u8D25, "+t.name);return}const i=await fetch(c).then(m=>m.text());console.log(`// ${t.name}
${i}`),s.value.push({name:t.name,reference:r.name,raw:i,htmlUrl:t.html_url})}}));break}}else if(p.name==="package.json"){const n=p.download_url;if(!n){message.error("\u65E0\u6CD5\u83B7\u53D6 package.json \u6587\u4EF6\u7684\u4E0B\u8F7D\u5730\u5740");return}const t=await fetch(n).then(i=>i.text()),c=JSON.parse(t);console.log("// package.json"),console.log(c),a.value=Object.entries(c.dependencies||{}).map(([i,m])=>`${i}@${m}`)}});await Promise.all(l),u.value=!1}});const o=async()=>{const d={snippets:s.value.map(p=>({name:j.basename(p.name,j.extname(p.name)),reference:p.reference,raw:p.raw,private:!1,type:y.Function})),packages:re(a)},l=message.loading("\u6B63\u5728\u5BFC\u5165...",{duration:1e6});await g.api.snippets.more.post({data:d,timeout:1e6}),l.destroy(),message.success("\u5BFC\u5165\u6210\u529F"),r.onFinish()};return()=>{const{name:d}=r;return e("div",null,e("p",null,"\u83B7\u53D6\uFF1A ",d),u.value?e("div",{class:"h-24 relative"},e(H,{description:"\u9700\u8981\u4ECE GitHub \u83B7\u53D6\uFF0C\u5EFA\u8BAE\u8FDE\u63A5\u4EE3\u7406\u540E\u64CD\u4F5C\u3002"})):e(T,null,e(f,{label:"\u5C06\u5BFC\u5165\u7684\u51FD\u6570\uFF1A"},e("div",{class:"space-x-2"},s.value.map(({name:l,reference:p,raw:n,htmlUrl:t},c)=>e(ue,{key:`${p}/${l}`,trigger:"hover",placement:"right"},{trigger(){return e(F,{text:!0,onClick:()=>{t&&window.open(t)},class:"cursor-pointer"},e(q,{closable:!0,onClose:i=>{i.stopPropagation(),s.value.splice(c,1)}},l))},default(){return e(M,{bordered:!1,title:l,class:"max-w-[40vw] max-h-[50vh] overflow-auto"},e(Pe,{code:n,language:"typescript"}))}})))),e(f,{label:"\u5C06\u5B89\u88C5\u7684\u4F9D\u8D56\uFF1A"},e("div",{class:"space-x-2"},a.value.map((l,p)=>e(q,{closable:!0,key:l,onClose:()=>{a.value.splice(p,1)}},l)))),e("div",{class:"flex justify-end"},e(F,{round:!0,type:"primary",onClick:o},"\u5BFC\u5165"))))}}}),qe=()=>{const r=h([]),u=async()=>{const s=await g.api.snippets.aggregate.post({data:[{$group:{_id:"$reference"}},{$project:{name:"$_id",_id:!1}}]});r.value=s.data.map(({name:a})=>a)};return N(()=>{u()}),r},Ue=w({setup(){const{data:r,fetchDataFn:u,loading:s,pager:a,checkedRowKeys:o}=Be((n,t)=>async(c,i,m)=>{const v=await g.api.snippets.get({params:{page:c,size:i,select:"-raw",db_query:m}});n.value=v.data,t.value=v.pagination}),d=qe();N(()=>{u(1,20)});const l=L();z(()=>(l.setHeaderButtons(e(k,null,e(E,{onClick:()=>{p.push({query:{tab:1}})},icon:e(le,null)}),e($e,{onFinish:()=>{u()}}),e(be,{checkedRowKeys:o,onDelete:async n=>{!n||(await Promise.all(n.map(t=>g.api.snippets(t).delete())),u(1,20),o.value.length=0)}}))),()=>{l.setHeaderButtons(null)}));const p=D();return()=>{const n=d.value.map(t=>({label:t,value:t}));return e(k,null,e(Ce,{onUpdateCheckedRowKeys:t=>{o.value=t},data:r,nTableProps:{onUpdateFilters(t){t.reference&&t.reference.length?u(1,20,{$or:t.reference.map(c=>({reference:c}))}):u(1,20)}},pager:a,columns:[{type:"selection",options:["none","all"]},{key:"name",title:"\u540D\u79F0",render(t){const c=t.name,i=t.private;return e(P,{align:"center"},t.type===y.Function&&e(V,null,e(se,null)),e(F,{tag:"a",text:!0,href:g.endpoint+(t.type===y.Function?"/serverless/":"/snippets/")+t.reference+"/"+t.name+(t.private?`?token=${oe()}`:""),target:"_blank",size:"tiny"},c),i&&e(V,{class:"items-center flex "},e(Te,null)))}},{title:"\u7C7B\u578B",key:"type"},{title:"\u5F15\u7528",key:"reference",filter:!0,filterOptions:n},{key:"comment",title:"\u5907\u6CE8",width:300,ellipsis:{tooltip:!0}},{title:"\u521B\u5EFA\u4E8E",key:"created",render(t){return e(xe,{time:t.created})}},{title:"\u64CD\u4F5C",key:"id",fixed:"right",render(t){return e(P,null,e(F,{text:!0,size:"tiny",type:"primary",onClick:()=>{p.push({query:{tab:1,id:t.id}})}},"\u7F16\u8F91"),e(Se,{positiveText:"\u53D6\u6D88",negativeText:"\u5220\u9664",onNegativeClick:async()=>{await g.api.snippets(t.id).delete(),message.success("\u5220\u9664\u6210\u529F"),await u(a.value.currentPage)}},{trigger:()=>e(F,{text:!0,type:"error",size:"tiny"},"\u79FB\u9664"),default:()=>e("span",{class:"max-w-48"},"\u786E\u5B9A\u8981\u5220\u9664 ",t.title," ?")}))}}],loading:s.value}))}}});var gt=w({name:"SnippetView",setup(){const r=R(),u=D(),s=J(()=>r.query.tab||"0");return()=>e(ie,null,e(_e,{size:"medium",value:s.value,onUpdateValue:a=>{u.push({query:{tab:a}})}},e(U,{name:"0",tab:"\u5217\u8868"},e(Ue,null)),e(U,{name:"1",tab:"\u7F16\u8F91",displayDirective:"if"},e(Oe,null))))}});export{gt as default};
