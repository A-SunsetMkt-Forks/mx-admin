import{d as w,X as O,al as I,w as x,o as R,t as j,a$ as A,h as t,O as k,av as L,I as F,b0 as N,b1 as M,J as U,L as K}from"./vendor-a7b34205.js";import{R as i,u as S,C as q,A as z,a as H}from"./index-66557411.js";import{T as V}from"./title-link-b7884d48.js";import{D as _}from"./delete-confirm-93a73628.js";import{T as J}from"./index-bfc15a67.js";import{E as X}from"./edit-column-101e7ac3.js";import{R as b}from"./relative-time-926545d3.js";import{u as $}from"./use-table-86e8e7b0.js";import{H as G}from"./rounded-button-e182bc33.js";const oe=w({name:"PostList",setup(){const{loading:T,checkedRowKeys:l,data:p,pager:m,sortProps:n,fetchDataFn:C}=$((s,r)=>async(e=v.query.page||1,y=20)=>{const a=await i.api.posts.get({params:{page:e,size:y,select:"title _id id created modified slug categoryId copyright tags count",...n.sortBy?{sortBy:n.sortBy,sortOrder:n.sortOrder}:{}}});s.value=a.data,r.value=a.pagination}),g=O(),v=I(),o=C;x(()=>v.query.page,async s=>{await o(s)});const u=S(q);R(async()=>{await o(),await u.fetch()});const P=w({setup(){const s=j(()=>u.data.value?.map(e=>({label:e.name,value:e.id}))||[]),r=A([{type:"selection",options:["none","all"]},{title:"\u6807\u9898",sortOrder:!1,sorter:"default",key:"title",width:200,ellipsis:!0,render(e){return t(k,null,t(V,{id:e.id,title:e.title,inPageTo:"/posts/edit?id="+e.id,externalLinkTo:"/posts/"+e.category.slug+"/"+e.slug}))}},{title:"\u5206\u7C7B",sortOrder:!1,sorter:"default",key:"category",width:80,ellipsis:!0,filterOptions:s,filter:!0,render(e){return u.map.value?t(X,{returnToConfrim:!1,initialValue:u.map.value.get(e.categoryId)?.name??"",onSubmit:async a=>{await i.api.posts(e.id).patch({data:{categoryId:a}}),g.success("\u4FEE\u6539\u6210\u529F~!"),p.value.find(f=>f.id===e.id).categoryId=a},type:"select",options:u.data.value?.map(a=>({label:a.name,value:a.id,key:a.id}))||[]}):""}},{title:"\u6807\u7B7E",key:"tags",width:100,ellipsis:!0,render(e){return e.tags?.join("\uFF0C")}},{title:()=>t(F,null,t(L,null)),key:"count.read",width:50,render(e){return e.count?.read||0}},{title:()=>t(F,null,t(N,null)),width:50,key:"count.like",render(e){return e.count?.like||0}},{title:"\u521B\u5EFA\u4E8E",width:100,key:"created",sortOrder:"descend",sorter:"default",render(e){return t(b,{time:e.created})}},{title:"\u4FEE\u6539\u4E8E",key:"modified",sorter:"default",sortOrder:!1,width:100,render(e){return t(b,{time:e.modified})}},{title:"\u64CD\u4F5C",fixed:"right",width:60,key:"id",render(e){return t(K,null,t(M,{positiveText:"\u53D6\u6D88",negativeText:"\u5220\u9664",onNegativeClick:async()=>{await i.api.posts(e.id).delete(),g.success("\u5220\u9664\u6210\u529F"),await o(m.value.currentPage)}},{trigger:()=>t(U,{text:!0,type:"error",size:"tiny"},"\u79FB\u9664"),default:()=>t("span",{class:"max-w-48"},"\u786E\u5B9A\u8981\u5220\u9664 ",e.title," ?")}))}}]);return()=>t(J,{loading:T.value,columns:r,data:p,nTableProps:{onUpdateFilters:async(e,y)=>{if(!!e&&e.category&&Array.isArray(e.category)){if(!e.category.length){await o();return}const f=e.category.join(",");let{entries:B}=await i.api.categories.get({params:{ids:f}});const D=Object.values(B).reduce((h,d)=>{const E=d.children?.map(c=>(Object.defineProperty(c,"categoryId",{value:d.id,enumerable:!0}),Object.defineProperty(c,"category",{get(){return c},enumerable:!1}),c));return[...h,...E]},[]).sort((h,d)=>+new Date(h.created)-+new Date(d.created));p.value=D,m.value={currentPage:1,total:1,size:0,hasNextPage:!1,hasPrevPage:!1,totalPage:1}}}},onFetchData:o,pager:m,onUpdateCheckedRowKeys:e=>{l.value=e},onUpdateSorter:async e=>{n.sortBy=e.sortBy,n.sortOrder=e.sortOrder}})}});return()=>t(H,null,{actions:()=>t(k,null,t(_,{checkedRowKeys:l.value,onDelete:async()=>{const s=await Promise.allSettled(l.value.map(r=>i.api.posts(r).delete()));for(const r of s)r.status==="rejected"&&g.success("\u5220\u9664\u5931\u8D25\uFF0C"+r.reason.message);l.value.length=0,o()}}),t(G,{to:"/posts/edit",icon:t(z,null)})),default:()=>t(P,null)})}});export{oe as ManagePostListView};
