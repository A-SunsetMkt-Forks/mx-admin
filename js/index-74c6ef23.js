import{bP as P,d as b,v as D,w as g,h as e,t as _,f as V,k as R,dW as A,l as L,ch as $,b_ as J,u as z,dp as C,y as h,bi as H,R as d,bX as T,j as U,F as x,a as B,I as O,dX as I,N as w,g as Y,A as G,m as K}from"./index-7e4abaa4.js";import{H as j}from"./rounded-button-082a5d75.js";import{u as q}from"./use-react-8c6f4029.js";import{d as X,l as k}from"./js-yaml-fae8e8ce.js";import{u as W,T as Q}from"./use-async-monaco-ad884df8.js";import{F as Z,d as ee,S as te,a as m,b as ae}from"./index-7c79fbca.js";import{o as ne}from"./omit-599ff41b.js";import{_ as ue}from"./CheckCircleOutlined-ce4ec0e7.js";import{N as re}from"./Form-77af3073.js";import{N as f}from"./FormItem-f13e1cd5.js";import{N as se}from"./Select-6e34ede7.js";import{N as oe}from"./Switch-4e7230c3.js";import{D as le}from"./delete-confirm-f0a8699e.js";import{T as ie}from"./index-87b85910.js";import{R as ce}from"./relative-time-bd1d5a91.js";import{u as pe}from"./use-table-a5e998f9.js";import{N as me}from"./Popconfirm-583f4956.js";import{N as de,a as E}from"./Tabs-b9b7c35d.js";import"./index-f001a2b4.js";import"./use-save-confirm-74164de5.js";import"./editor.main-759b9211.js";import"./_arrayEach-2ff48152.js";import"./index-47d73072.js";import"./Tag-1d6bc2b4.js";import"./DataTable-7b1f1195.js";import"./Icon-a62043a5.js";import"./Forward-1b533f06.js";import"./ChevronRight-6c0d4f97.js";import"./Tooltip-0f30bb26.js";import"./Add-cbde1fd4.js";import"./throttle-5c3590fd.js";var M={};Object.defineProperty(M,"__esModule",{value:!0});const N=P,ve={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 1024 1024"},fe=(0,N.createElementVNode)("path",{d:"M832 464h-68V240c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zM540 701v53c0 4.4-3.6 8-8 8h-40c-4.4 0-8-3.6-8-8v-53a48.01 48.01 0 1 1 56 0zm152-237H332V240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v224z",fill:"currentColor"},null,-1),ye=[fe];var he=M.default=(0,N.defineComponent)({name:"LockFilled",render:function(r,u){return(0,N.openBlock)(),(0,N.createElementBlock)("svg",ve,ye)}});const ge=b({props:{onSave:{type:Function},value:{type:String,required:!0},onChange:{type:Function,required:!0},language:{type:String,required:!0}},setup(s){const r=W(s),u=D();return g(()=>r.value,()=>{!u.value||u.value.loaded&&s.onChange(r.value)}),()=>e("div",{class:"h-full w-full relative"},e(Z,{ref:u,value:r,onSave:s.onSave,language:s.language}))}}),Fe=b({setup(){const s=_(),r=V(),u=R(()=>r.query.id),n=A(u.value?"snippet-"+u.value:"snippet",new ae),l=L(u.value?{json:"",yaml:"",text:"",function:""}:{json:JSON.stringify({name:"hello world"},null,2),text:"",yaml:"name: hello world",function:ee});g(()=>n.value.type,a=>{n.value.raw=l[a]}),g(()=>[l.json,l.yaml],$(([a,t],[i,o])=>{const c=a!==i,p=t!==o,S=H(l);try{c?S.yaml=X(JSON.parse(a)):p&&(S.json=JSON.stringify(k(t),null,2))}catch{}},100)),g(()=>[n.value.type,n.value.schema],([a,t])=>{if(a===m.JSON){if(!n.value.schema){T(()=>import("./editor.main-759b9211.js").then(function(o){return o.e}),["js/editor.main-759b9211.js","assets/editor.main.2109f3ac.css"]).then(o=>{o.languages.json.jsonDefaults.setDiagnosticsOptions({validate:!1})});return}const i=n.value.schema;fetch(i).then(o=>o.text()).then(o=>{T(()=>import("./editor.main-759b9211.js").then(function(c){return c.e}),["js/editor.main-759b9211.js","assets/editor.main.2109f3ac.css"]).then(c=>{c.languages.json.jsonDefaults.setDiagnosticsOptions({validate:!0,schemas:[{uri:i,fileMatch:["*"],schema:JSON.parse(o)}]})})})}}),g(()=>u,async a=>{if(a.value){const t=await d.api.snippets(a.value).get();switch(t.type){case m.JSON:{t.raw=JSON.stringify(JSON.parse(t.raw),null,2);break}}n.value=t,l[t.type]=t.raw}},{immediate:!0});const F=J(),v=z(),y=async(a=!0)=>{const t=p=>{try{return JSON.stringify(JSON.parse(p),null,0)}catch{v.error("JSON \u683C\u5F0F\u9519\u8BEF")}},i=()=>{const p=l[n.value.type];switch(n.value.type){case m.JSON:return t(p);case m.YAML:{try{k(p)}catch{v.error("YAML \u683C\u5F0F\u9519\u8BEF")}return p}case m.Function:return p;default:return p}},c={...ne(n.value,["_id","id","created","data"]),raw:i()};c.metatype||delete c.metatype,u.value?await d.api.snippets(u.value).put({data:c}):await d.api.snippets.post({data:c}),v.success(`${u.value?"\u66F4\u65B0":"\u521B\u5EFA"}\u6210\u529F`),a&&s.replace({query:{...r.query,tab:0}})};return q(()=>(F.setHeaderButtons(e(j,{variant:"success",onClick:()=>y(),icon:e(ue,null)})),()=>{F.setHeaderButtons(null)})),()=>e(Q,null,e(C,{span:12},e(re,null,e(f,{label:"\u540D\u79F0",required:!0},e(h,{onUpdateValue:a=>void(n.value.name=a),value:n.value.name})),e(f,{label:"\u5F15\u7528",required:!0},e(h,{value:n.value.reference,onUpdateValue:a=>void(n.value.reference=a),defaultValue:"root"})),e(f,{label:"\u5143\u7C7B\u578B"},e(h,{value:n.value.metatype,onUpdateValue:a=>void(n.value.metatype=a)})),e(f,{label:"\u6570\u636E\u7C7B\u578B"},e(se,{value:n.value.type,defaultValue:m.JSON,onUpdateValue:a=>void(n.value.type=a),options:Object.entries(m).map(([a,t])=>({label:a,value:t}))})),e(f,{label:"Schema"},e(h,{value:n.value.schema,onUpdateValue:a=>void(n.value.schema=a)})),e(f,{label:"\u516C\u5F00",labelPlacement:"left"},e("div",{class:"w-full flex justify-end"},e(oe,{value:!n.value.private,onUpdateValue:a=>void(n.value.private=!a)}))),e(f,{label:"\u5907\u6CE8"},e(h,{resizable:!1,value:n.value.comment,onUpdateValue:a=>void(n.value.comment=a),type:"textarea",rows:4})))),e(C,{span:24},e(ge,{onSave:async()=>{await y(!1),v.success("Saved!")},language:te[n.value.type],value:l[n.value.type],onChange:a=>{l[n.value.type]=a}})))}}),Ne=()=>{const s=D([]),r=async()=>{const u=await d.api.snippets.aggregate.post({data:[{$group:{_id:"$reference"}},{$project:{name:"$_id",_id:!1}}]});s.value=u.data.map(({name:n})=>n)};return U(()=>{r()}),s},be=b({setup(){const{data:s,fetchDataFn:r,loading:u,pager:n,checkedRowKeys:l}=pe((a,t)=>async(i,o,c)=>{const p=await d.api.snippets.get({params:{page:i,size:o,select:"-raw",db_query:c}});a.value=p.data,t.value=p.pagination}),F=Ne();U(()=>{r(1,20)});const v=J();q(()=>(v.setHeaderButtons(e(x,null,e(j,{onClick:()=>{y.push({query:{tab:1}})},icon:e(G,null)}),e(le,{checkedRowKeys:l,onDelete:async a=>{!a||(await Promise.all(a.map(t=>d.api.snippets(t).delete())),r(1,20),l.value.length=0)}}))),()=>{v.setHeaderButtons(null)}));const y=_();return()=>{const a=F.value.map(t=>({label:t,value:t}));return e(x,null,e(ie,{onUpdateCheckedRowKeys:t=>{l.value=t},data:s,nTableProps:{onUpdateFilters(t){t.reference&&t.reference.length?r(1,20,{$or:t.reference.map(i=>({reference:i}))}):r(1,20)}},pager:n,columns:[{type:"selection",options:["none","all"]},{key:"name",title:"\u540D\u79F0",render(t){const i=t.name,o=t.private;return e(B,{align:"center"},t.type===m.Function&&e(O,null,e(I,null)),e(w,{tag:"a",text:!0,href:d.endpoint+(t.type===m.Function?"/serverless/":"/snippets/")+t.reference+"/"+t.name+(t.private?`?token=${Y()}`:""),target:"_blank",size:"tiny"},i),o&&e(O,{class:"items-center flex "},e(he,null)))}},{title:"\u7C7B\u578B",key:"type"},{title:"\u5F15\u7528",key:"reference",filter:!0,filterOptions:a},{key:"comment",title:"\u5907\u6CE8",width:300,ellipsis:{tooltip:!0}},{title:"\u521B\u5EFA\u4E8E",key:"created",render(t){return e(ce,{time:t.created})}},{title:"\u64CD\u4F5C",key:"id",fixed:"right",render(t){return e(B,null,e(w,{text:!0,size:"tiny",type:"primary",onClick:()=>{y.push({query:{tab:1,id:t.id}})}},"\u7F16\u8F91"),e(me,{positiveText:"\u53D6\u6D88",negativeText:"\u5220\u9664",onNegativeClick:async()=>{await d.api.snippets(t.id).delete(),message.success("\u5220\u9664\u6210\u529F"),await r(n.value.currentPage)}},{trigger:()=>e(w,{text:!0,type:"error",size:"tiny"},"\u79FB\u9664"),default:()=>e("span",{class:"max-w-48"},"\u786E\u5B9A\u8981\u5220\u9664 ",t.title," ?")}))}}],loading:u.value}))}}});var Ze=b({name:"SnippetView",setup(){const s=V(),r=_(),u=R(()=>s.query.tab||"0");return()=>e(K,null,e(de,{size:"medium",value:u.value,onUpdateValue:n=>{r.push({query:{tab:n}})}},e(E,{name:"0",tab:"\u5217\u8868"},e(be,null)),e(E,{name:"1",tab:"\u7F16\u8F91"},e(Fe,null))))}});export{Ze as default};
