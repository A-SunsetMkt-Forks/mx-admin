import{e as x,R as m,_ as T,F as A,g as P,A as j,a as L}from"./index-66557411.js";import{d as b,r as J,w as h,h as e,u as N,al as R,t as k,cd as M,a$ as $,s as I,X as H,$ as C,bh as z,ba as f,G as g,b8 as G,bc as Y,be as K,c8 as X,c7 as Q,o as U,O,L as _,I as B,J as S,ce as W,b1 as Z,bO as ee,bP as D}from"./vendor-a7b34205.js";import{H as V}from"./rounded-button-e182bc33.js";import{u as q}from"./use-react-1ab208ae.js";import{d as ae,l as E}from"./js-yaml-fae8e8ce.js";import{u as te,T as ue}from"./use-async-monaco-35b689e3.js";import{F as ne,d as se,S as re,a as d,b as le}from"./index-3343cd08.js";import{D as oe}from"./delete-confirm-93a73628.js";import{T as ie}from"./index-bfc15a67.js";import{R as ce}from"./relative-time-926545d3.js";import{u as pe}from"./use-table-86e8e7b0.js";import"./index-76d8504b.js";import"./use-save-confirm-3e742716.js";import"./editor.main-759b9211.js";const de=b({props:{onSave:{type:Function},value:{type:String,required:!0},onChange:{type:Function,required:!0},language:{type:String,required:!0}},setup(l){const s=te(l),n=J();return h(()=>s.value,()=>{!n.value||n.value.loaded&&l.onChange(s.value)}),()=>e("div",{class:"h-full w-full relative"},e(ne,{ref:n,value:s,onSave:l.onSave,language:l.language}))}}),me=b({setup(){const l=N(),s=R(),n=k(()=>s.query.id),u=M(n.value?"snippet-"+n.value:"snippet",new le),o=$(n.value?{json:"",yaml:"",text:"",function:""}:{json:JSON.stringify({name:"hello world"},null,2),text:"",yaml:"name: hello world",function:se});h(()=>u.value.type,t=>{u.value.raw=o[t]}),h(()=>[o.json,o.yaml],I(([t,a],[i,r])=>{const c=t!==i,p=a!==r,w=K(o);try{c?w.yaml=ae(JSON.parse(t)):p&&(w.json=JSON.stringify(E(a),null,2))}catch{}},100)),h(()=>[u.value.type,u.value.schema],([t,a])=>{if(t===d.JSON){if(!u.value.schema){T(()=>import("./editor.main-759b9211.js").then(function(r){return r.e}),["js/editor.main-759b9211.js","assets/editor.main.2109f3ac.css"]).then(r=>{r.languages.json.jsonDefaults.setDiagnosticsOptions({validate:!1})});return}const i=u.value.schema;fetch(i).then(r=>r.text()).then(r=>{T(()=>import("./editor.main-759b9211.js").then(function(c){return c.e}),["js/editor.main-759b9211.js","assets/editor.main.2109f3ac.css"]).then(c=>{c.languages.json.jsonDefaults.setDiagnosticsOptions({validate:!0,schemas:[{uri:i,fileMatch:["*"],schema:JSON.parse(r)}]})})})}}),h(()=>n,async t=>{if(t.value){const a=await m.api.snippets(t.value).get();switch(a.type){case d.JSON:{a.raw=JSON.stringify(JSON.parse(a.raw),null,2);break}}u.value=a,o[a.type]=a.raw}},{immediate:!0});const F=x(),v=H(),y=async(t=!0)=>{const a=p=>{try{return JSON.stringify(JSON.parse(p),null,0)}catch{v.error("JSON \u683C\u5F0F\u9519\u8BEF")}},i=()=>{const p=o[u.value.type];switch(u.value.type){case d.JSON:return a(p);case d.YAML:{try{E(p)}catch{v.error("YAML \u683C\u5F0F\u9519\u8BEF")}return p}case d.Function:return p;default:return p}},c={...X(u.value,["_id","id","created","data"]),raw:i()};c.metatype||delete c.metatype,n.value?await m.api.snippets(n.value).put({data:c}):await m.api.snippets.post({data:c}),v.success(`${n.value?"\u66F4\u65B0":"\u521B\u5EFA"}\u6210\u529F`),t&&l.replace({query:{...s.query,tab:0}})};return q(()=>(F.setHeaderButtons(e(V,{variant:"success",onClick:()=>y(),icon:e(Q,null)})),()=>{F.setHeaderButtons(null)})),()=>e(ue,null,e(C,{span:12},e(z,null,e(f,{label:"\u540D\u79F0",required:!0},e(g,{onUpdateValue:t=>void(u.value.name=t),value:u.value.name})),e(f,{label:"\u5F15\u7528",required:!0},e(g,{value:u.value.reference,onUpdateValue:t=>void(u.value.reference=t),defaultValue:"root"})),e(f,{label:"\u5143\u7C7B\u578B"},e(g,{value:u.value.metatype,onUpdateValue:t=>void(u.value.metatype=t)})),e(f,{label:"\u6570\u636E\u7C7B\u578B"},e(G,{value:u.value.type,defaultValue:d.JSON,onUpdateValue:t=>void(u.value.type=t),options:Object.entries(d).map(([t,a])=>({label:t,value:a}))})),e(f,{label:"Schema"},e(g,{value:u.value.schema,onUpdateValue:t=>void(u.value.schema=t)})),e(f,{label:"\u516C\u5F00",labelPlacement:"left"},e("div",{class:"w-full flex justify-end"},e(Y,{value:!u.value.private,onUpdateValue:t=>void(u.value.private=!t)}))),e(f,{label:"\u5907\u6CE8"},e(g,{resizable:!1,value:u.value.comment,onUpdateValue:t=>void(u.value.comment=t),type:"textarea",rows:4})))),e(C,{span:24},e(de,{onSave:async()=>{await y(!1),v.success("Saved!")},language:re[u.value.type],value:o[u.value.type],onChange:t=>{o[u.value.type]=t}})))}}),ve=()=>{const l=J([]),s=async()=>{const n=await m.api.snippets.aggregate.post({data:[{$group:{_id:"$reference"}},{$project:{name:"$_id",_id:!1}}]});l.value=n.data.map(({name:u})=>u)};return U(()=>{s()}),l},fe=b({setup(){const{data:l,fetchDataFn:s,loading:n,pager:u,checkedRowKeys:o}=pe((t,a)=>async(i,r,c)=>{const p=await m.api.snippets.get({params:{page:i,size:r,select:"-raw",db_query:c}});t.value=p.data,a.value=p.pagination}),F=ve();U(()=>{s(1,20)});const v=x();q(()=>(v.setHeaderButtons(e(O,null,e(V,{onClick:()=>{y.push({query:{tab:1}})},icon:e(j,null)}),e(oe,{checkedRowKeys:o,onDelete:async t=>{!t||(await Promise.all(t.map(a=>m.api.snippets(a).delete())),s(1,20),o.value.length=0)}}))),()=>{v.setHeaderButtons(null)}));const y=N();return()=>{const t=F.value.map(a=>({label:a,value:a}));return e(O,null,e(ie,{onUpdateCheckedRowKeys:a=>{o.value=a},data:l,nTableProps:{onUpdateFilters(a){a.reference&&a.reference.length?s(1,20,{$or:a.reference.map(i=>({reference:i}))}):s(1,20)}},pager:u,columns:[{type:"selection",options:["none","all"]},{key:"name",title:"\u540D\u79F0",render(a){const i=a.name,r=a.private;return e(_,{align:"center"},a.type===d.Function&&e(B,null,e(A,null)),e(S,{tag:"a",text:!0,href:m.endpoint+(a.type===d.Function?"/serverless/":"/snippets/")+a.reference+"/"+a.name+(a.private?`?token=${P()}`:""),target:"_blank",size:"tiny"},i),r&&e(B,{class:"items-center flex "},e(W,null)))}},{title:"\u7C7B\u578B",key:"type"},{title:"\u5F15\u7528",key:"reference",filter:!0,filterOptions:t},{key:"comment",title:"\u5907\u6CE8",width:300,ellipsis:{tooltip:!0}},{title:"\u521B\u5EFA\u4E8E",key:"created",render(a){return e(ce,{time:a.created})}},{title:"\u64CD\u4F5C",key:"id",fixed:"right",render(a){return e(_,null,e(S,{text:!0,size:"tiny",type:"primary",onClick:()=>{y.push({query:{tab:1,id:a.id}})}},"\u7F16\u8F91"),e(Z,{positiveText:"\u53D6\u6D88",negativeText:"\u5220\u9664",onNegativeClick:async()=>{await m.api.snippets(a.id).delete(),message.success("\u5220\u9664\u6210\u529F"),await s(u.value.currentPage)}},{trigger:()=>e(S,{text:!0,type:"error",size:"tiny"},"\u79FB\u9664"),default:()=>e("span",{class:"max-w-48"},"\u786E\u5B9A\u8981\u5220\u9664 ",a.title," ?")}))}}],loading:n.value}))}}});var Ee=b({name:"SnippetView",setup(){const l=R(),s=N(),n=k(()=>l.query.tab||"0");return()=>e(L,null,e(ee,{size:"medium",value:n.value,onUpdateValue:u=>{s.push({query:{tab:u}})}},e(D,{name:"0",tab:"\u5217\u8868"},e(fe,null)),e(D,{name:"1",tab:"\u7F16\u8F91"},e(me,null))))}});export{Ee as default};
